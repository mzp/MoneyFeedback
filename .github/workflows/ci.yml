name: CI
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  macos:
    runs-on: macos-26
    steps:
      - name: Health check
        run: |
          set -x
          sw_vers
          xcrun --find xcodebuild
          xcrun --find swift-format
          ls /Applications
          which xcpretty

      - uses: actions/checkout@v4

      - name: Lint
        run: xcrun swift-format lint -r .

      - name: Build IPA
        run: |
          set -o pipefail
          xcodebuild -project MoneyFeedback.xcodeproj \
                     -scheme MoneyFeedback \
                     -configuration Release \
                     -destination generic/platform=iOS \
                     -archivePath MoneyFeedback.xcarchive \
                     archive \
                | tee xcodebuild-archive.log \
                | xcpretty
          xcodebuild -exportArchive \
                     -archivePath MoneyFeedback.xcarchive \
                     -exportPath . \
                     -exportOptionsPlist MoneyFeedback/ExportOptions.plist \
                | tee xcodebuild-export.log \
                | xcpretty

      - name: Upload Build Logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: XcodeBuild-Logs
          path: |
            xcodebuild-archive.log
            xcodebuild-export.log
